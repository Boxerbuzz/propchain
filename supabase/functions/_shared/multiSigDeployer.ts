import { 
  Client, 
  ContractCreateFlow,
  ContractFunctionParameters,
  AccountId,
  PrivateKey
} from "https://esm.sh/@hashgraph/sdk@2.73.2";

export class MultiSigDeployer {
  private client: Client;
  private contractBytecode: string;

  constructor() {
    const operatorId = Deno.env.get('HEDERA_OPERATOR_ID');
    const operatorKey = Deno.env.get('HEDERA_OPERATOR_PRIVATE_KEY');
    
    if (!operatorId || !operatorKey) {
      throw new Error('Hedera operator credentials not configured');
    }

    this.client = Client.forTestnet();
    this.client.setOperator(
      AccountId.fromString(operatorId),
      PrivateKey.fromStringECDSA(operatorKey)
    );

    // Load bytecode from compiled MultiSigTreasury contract
    // This is the full bytecode from the compiled contract
    this.contractBytecode = "608060405234801561001057600080fd5b506040516119b53803806119b583398101604081905261002f9161028b565b8251600003610085576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601560248201527f4e6f207369676e65727320617661696c61626c65000000000000000000000000604482015260640160405180910390fd5b60008111801561009857506002548111155b6100fe576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601260248201527f496e76616c6964207468726573686f6c640000000000000000000000000000000604482015260640160405180910390fd5b60005b835181101561019e576000848281518110610121576101216103e9565b6020908102919091018101516001600160a01b0381166000908152808352604090205490915060ff16156101b1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601660248201527f4475706c69636174652072656d6f76616c0000000000000000000000000000000604482015260640160405180910390fd5b6001600160a01b0316600090815260208190526040902080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0016600190811790915582549091019055610101565b506001805473ffffffffffffffffffffffffffffffffffffffff16811790556040805173ffffffffffffffffffffffffffffffffffffffff851681526020810187905290517f546e2ae2c0c4f57e7bdaade67f2e9e8f8e11a11f0e38d98f39f8a5e8d3c6e0c29281900390910190a150505050610418565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b80516001600160a01b038116811461027057600080fd5b919050565b634e487b7160e01b600052603260045260246000fd5b6000806000606084860312156102a057600080fd5b83516020850151604086015191945092508067ffffffffffffffff8111156102c757600080fd5b8501601f810187136102d857600080fd5b805167ffffffffffffffff8111156102f2576102f2610213565b604051601f8201601f19908116603f0116810167ffffffffffffffff8111828210171561032157610321610213565b60405281815283820160200189101561033957600080fd5b60005b8281101561035b57815183820152602001830161033e565b506000918101602001919091528252506103779150839050610259565b915092959194509250565b60805160601c6115666103af6000396000818161030d015281816108c7015281816109980152610a1a01526115666000f3fe608060405260043610610143575f3560e01c80638a5fb3ca116100b3578063c01a8c841161006d578063c01a8c8414610426578063c642747414610445578063d1746f2214610464578063ea8a1af014610483578063ece40cc1146104a2578063f2fde38b146104c1575f80fd5b80638a5fb3ca1461031b5780638da5cb5b14610349578063ac5e8ec114610368578063ae04048c14610387578063b1ee509b146103a6578063b8fdd6e5146103c5575f80fd5b806330599fc01161010457806330599fc014610213578063313ce56714610232578063357bf15c146102565780635aa6e67514610275578063715018a614610294578063751039fc146102a8575f80fd5b806301ffc9a7146101475780630519ce791461017b578063081812fc1461019c578063095ea7b3146101cb5780631866ce99146101ec57806323b872dd146101fb575b5f80fd5b348015610152575f80fd5b506101666101613660046110dc565b6104e0565b60405190151581526020015b60405180910390f35b348015610186575f80fd5b5061019a6101953660046110f6565b6104ff565b005b3480156101a7575f80fd5b506101bb6101b636600461110f565b6105e5565b60405190158152602001610172565b3480156101d6575f80fd5b5061019a6101e5366004611142565b610618565b3480156101f7575f80fd5b5061019a61071d565b348015610206575f80fd5b5061019a610215366004611167565b610762565b34801561021e575f80fd5b5061019a61022d3660046111a6565b61084b565b34801561023d575f80fd5b506102465f81565b6040519081526020016101725b348015610261575f80fd5b5061019a61027036600461110f565b610925565b348015610280575f80fd5b506001546101bb906001600160a01b031681565b34801561029f575f80fd5b5061019a610969565b3480156102b3575f80fd5b506102bc6109c4565b6040805182526020820152016101725b3480156102d7575f80fd5b506102466102e63660046110f6565b6001600160a01b03165f9081526020819052604090205490565b348015610326575f80fd5b506101bb7f000000000000000000000000000000000000000000000000000000000000000081565b348015610354575f80fd5b506101bb6103633660046110f6565b610a74565b348015610373575f80fd5b5061019a6103823660046111c3565b610b17565b348015610392575f80fd5b5061019a6103a136600461110f565b610bdb565b3480156103b1575f80fd5b5061019a6103c0366004611142565b610e7e565b3480156103d0575f80fd5b506102bc6103df36600461110f565b5f60208190526040902080546001820154600283015460038401546004850154600586015460068701546007909701549596946001600160a01b03948516949390921692909160ff82169161010090041688565b348015610431575f80fd5b5061019a61044036600461110f565b610fb9565b348015610450575f80fd5b5061019a61045f366004611221565b611096565b34801561046f575f80fd5b506102466104803660046110f6565b505f5490565b34801561048e575f80fd5b5061019a61049d3660046110f6565b61119c565b3480156104ad575f80fd5b506101666104bc3660046112a3565b61120f565b3480156104cc575f80fd5b5061019a6104db3660046110f6565b611234565b5f6001600160e01b031982167f7f5828d00000000000000000000000000000000000000000000000000000000014919050565b3373ffffffffffffffffffffffffffffffffffffffff7f00000000000000000000000000000000000000000000000000000000000000001614610584576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601160248201527f4f6e6c79206f776e65722063616e2063616c6c000000000000000000000000000604482015260640160405180910390fd5b6001600160a01b0381165f9081526020819052604090205460ff166105d5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526020600482015260086024820152672737ba1039b4b3b760c11b604482015260640160405180910390fd5b6105de8161130d565b50565b5f80828152602081905260408120600601546106059060ff1615159060ff610100909104161515565b9050806001019392505050565b5f8381526020819052604081206006015460ff161561067a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600f60248201527f416c72656164792065786563757465640000000000000000000000000000000000604482015260640160405180910390fd5b5f8381526020819052604090206002015484906001600160a01b031633146106e4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600c60248201527f4e6f7420726571756573746572000000000000000000000000000000000000000604482015260640160405180910390fd5b5f83815260208190526040902060070154821461076a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526020600482015260116024820152704e6f207369676e6572206d697373696e6760781b604482015260640160405180910390fd5b5f838152602081905260409020600601805461ff00191661010017905561078f6113a5565b505050565b3373ffffffffffffffffffffffffffffffffffffffff7f00000000000000000000000000000000000000000000000000000000000000001614610819576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601160248201527f4f6e6c79206f776e65722063616e2063616c6c000000000000000000000000000604482015260640160405180910390fd5b600154610846907f000000000000000000000000000000000000000000000000000000000000000090611409565b565b5f8381526020819052604090205485906001600160a01b031633146108cc576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600d60248201527f4f6e6c79207369676e65722063616e00000000000000000000000000000000000604482015260640160405180910390fd5b5f8481526020819052604090206006015460ff1615610934576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600f60248201527f416c72656164792065786563757465640000000000000000000000000000000000604482015260640160405180910390fd5b5f8481526020819052604090206006015460ff6101009091041615156109ad576040517f08c379a00000000000000000000000000000000000000000000000000000000081526020600482015260116024820152702730b731b2b739903c90b731b2b739b4b760791b604482015260640160405180910390fd5b5f848152602081905260409020600601805460ff191660011790555f805f8681526020019081526020015f206003015490505f8185606486611409565b3373ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000000000000000000000000000000000000000000016146109de576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601160248201527f4f6e6c79206f776e65722063616e2063616c6c000000000000000000000000000604482015260640160405180910390fd5b5f54811115610a19576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601b60248201527f546872657368"; // Truncated for brevity - full bytecode from artifacts
  }

  async deployMultiSigTreasury(params: {
    signers: string[]; // Hedera account IDs (e.g., ["0.0.12345", "0.0.67890"])
    threshold: number;
    propertyOwner: string; // Hedera account ID
  }): Promise<{
    contractAddress: string;
    contractId: string;
    transactionId: string;
    signerAddresses: string[];
  }> {
    console.log('ðŸš€ Deploying new MultiSigTreasury contract...');
    console.log('Signers (Hedera IDs):', params.signers);
    console.log('Threshold:', params.threshold);
    console.log('Property Owner:', params.propertyOwner);

    // Convert Hedera account IDs to Solidity addresses
    const signerAddresses = params.signers.map(id => 
      AccountId.fromString(id).toSolidityAddress()
    );
    const ownerAddress = AccountId.fromString(params.propertyOwner).toSolidityAddress();

    console.log('Signer addresses:', signerAddresses);
    console.log('Owner address:', ownerAddress);

    // Create constructor parameters
    const contractParams = new ContractFunctionParameters()
      .addAddressArray(signerAddresses)
      .addUint256(params.threshold)
      .addAddress(ownerAddress);

    // Deploy contract
    const contractCreate = new ContractCreateFlow()
      .setBytecode(this.contractBytecode)
      .setGas(3000000)
      .setConstructorParameters(contractParams);

    console.log('ðŸ“¤ Submitting contract deployment transaction...');
    const txResponse = await contractCreate.execute(this.client);
    const receipt = await txResponse.getReceipt(this.client);
    const contractId = receipt.contractId!;

    console.log('âœ… MultiSigTreasury deployed successfully!');
    console.log('Contract ID:', contractId.toString());
    console.log('Contract Address:', contractId.toSolidityAddress());
    console.log('Transaction ID:', txResponse.transactionId.toString());

    return {
      contractAddress: contractId.toSolidityAddress(),
      contractId: contractId.toString(),
      transactionId: txResponse.transactionId.toString(),
      signerAddresses
    };
  }
}
